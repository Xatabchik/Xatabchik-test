{% extends 'base.html' %}
{% block title %}Тикет #{{ ticket.ticket_id }} — Поддержка{% endblock %}

{% block content %}
<div id="ticket-root" data-ticket-id="{{ ticket.ticket_id }}">
  <div class="page-header d-print-none mb-4">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="page-title mb-1">Тикет #{{ ticket.ticket_id }}</h1>
        <div class="text-secondary">
          <i class="ti ti-user me-1"></i>
          Пользователь: {{ ticket.user_id }} • 
          <i class="ti ti-message me-1"></i>
          Тема: {{ ticket.subject or 'Без темы' }}
        </div>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <a class="btn btn-outline-secondary" href="{{ url_for('support_list_page') }}">
          <i class="ti ti-arrow-left me-1"></i>
          К списку
        </a>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title mb-0">
        <i class="ti ti-info-circle me-2"></i>
        Информация о тикете
      </h3>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <strong class="me-2">Статус:</strong>
        <span id="ticket-status">
          {% if ticket.status == 'open' %}
            <span class="status-dot status-dot-animated bg-green"></span>
            <span class="badge bg-green ms-1">Открыт</span>
          {% else %}
            <span class="status-dot"></span>
            <span class="badge ms-1">Закрыт</span>
          {% endif %}
        </span>
      </div>

    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title mb-0">
        <i class="ti ti-messages me-2"></i>
        Переписка
      </h3>
    </div>
    <div class="card-body">
      <div class="chat-box" id="chat-box">
        {% for m in messages %}
          <div class="chat-message {% if m.sender == 'admin' %}from-admin{% else %}from-user{% endif %}">
            <div class="meta">
              <span class="sender">
                <i class="ti ti-{% if m.sender == 'admin' %}shield{% else %}user{% endif %} me-1"></i>
                {{ 'Админ' if m.sender == 'admin' else 'Пользователь' }}
              </span>
              <span class="time">
                <i class="ti ti-clock me-1"></i>
                {{ m.created_at }}
              </span>
            </div>
            <div class="content">{{ m.content }}</div>
          </div>
        {% else %}
          <p class="no-messages text-center text-secondary py-4">
            <i class="ti ti-message-off" style="font-size: 2rem; opacity: 0.5;"></i>
            <br>Сообщений пока нет.
          </p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title mb-0">
        <i class="ti ti-edit me-2"></i>
        Ответить
      </h3>
    </div>
    <div class="card-body">
      <form method="post" id="reply-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="mb-3">
          <textarea id="reply-text" name="message" class="form-control" rows="4" placeholder="Введите ответ администратора..." {% if ticket.status == 'closed' %}disabled{% endif %}></textarea>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button id="reply-btn" type="submit" name="action" value="reply" class="btn btn-primary" {% if ticket.status == 'closed' %}disabled{% endif %}>
            <i class="ti ti-send me-1"></i>
            Ответить
          </button>
          {% if ticket.status == 'open' %}
            <button id="toggle-status-btn" type="submit" name="action" value="close" class="btn btn-danger">
              <i class="ti ti-lock me-1"></i>
              Закрыть тикет
            </button>
          {% else %}
            <button id="toggle-status-btn" type="submit" name="action" value="open" class="btn btn-success">
              <i class="ti ti-lock-open me-1"></i>
              Открыть тикет
            </button>
          {% endif %}
          <form method="post" action="{{ url_for('delete_support_ticket_route', ticket_id=ticket.ticket_id) }}" onsubmit="return confirm('Удалить тикет #{{ ticket.ticket_id }}? Это действие необратимо.');" class="ms-auto">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn btn-outline-danger">
              <i class="ti ti-trash me-1"></i>
              Удалить тикет
            </button>
          </form>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
